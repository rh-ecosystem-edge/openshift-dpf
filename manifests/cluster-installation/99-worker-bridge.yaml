apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: worker
  name: worker-nmstate-bridge
spec:
  config:
    ignition:
      version: 3.2.0
    storage:
      files:
        - contents:
            source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKCkRFRkFVTFRfTVRVPTE1MDAKTk9ERVNfTVRVPSR7MTotJERFRkFVTFRfTVRVfQoKIyBXYWl0IGluZGVmaW5pdGVseSBmb3IgYW4gaW50ZXJmYWNlIHRvIGdldCBhbiBJUCBhZGRyZXNzIGFuZCBkZWZhdWx0IHJvdXRlCldBSVRfSU5URVJWQUw9NSAgIyBDaGVjayBpbnRlcnZhbCBpbiBzZWNvbmRzCkFUVEVNUFQ9MQoKZWNobyAiV2FpdGluZyBmb3IgbmV0d29yayBjb25maWd1cmF0aW9uLi4uIgp3aGlsZSB0cnVlOyBkbwogICAgIyBDaGVjayBpZiB3ZSBoYXZlIGFuIGludGVyZmFjZSB3aXRoIGEgZGVmYXVsdCByb3V0ZQogICAgREVGQVVMVF9JTlRFUkZBQ0U9JChpcCByb3V0ZSB8IGdyZXAgZGVmYXVsdCB8IGF3ayAne3ByaW50ICQ1fScgfCBoZWFkIC1uIDEpCgogICAgaWYgWyAtbiAiJERFRkFVTFRfSU5URVJGQUNFIiBdOyB0aGVuCiAgICAgICAgIyBDaGVjayBpZiB0aGF0IGludGVyZmFjZSBoYXMgYW4gSVAgYWRkcmVzcwogICAgICAgIElQX0FERFI9JChpcCBhZGRyIHNob3cgZGV2ICIkREVGQVVMVF9JTlRFUkZBQ0UiIHwgZ3JlcCAtdyAiaW5ldCIgfCBhd2sgJ3twcmludCAkMn0nKQoKICAgICAgICBpZiBbIC1uICIkSVBfQUREUiIgXTsgdGhlbgogICAgICAgICAgICBlY2hvICJOZXR3b3JrIGlzIHJlYWR5LiBJbnRlcmZhY2UgJERFRkFVTFRfSU5URVJGQUNFIGhhcyBJUCBhZGRyZXNzICRJUF9BRERSIgogICAgICAgICAgICBicmVhawogICAgICAgIGZpCiAgICBmaQoKICAgIGVjaG8gIldhaXRpbmcgZm9yIG5ldHdvcmsgY29uZmlndXJhdGlvbi4uLiAoQXR0ZW1wdCAkQVRURU1QVCkiCiAgICBzbGVlcCAkV0FJVF9JTlRFUlZBTAogICAgQVRURU1QVD0kKChBVFRFTVBUICsgMSkpCmRvbmUKCiMgQ2hlY2sgaWYgdGhlIGJyaWRnZSBhbHJlYWR5IGV4aXN0cwppZiBpcCBsaW5rIHNob3cgYnItZHB1ICY+L2Rldi9udWxsOyB0aGVuCiAgICBlY2hvICJCcmlkZ2UgYnItZHB1IGFscmVhZHkgZXhpc3RzLiBObyBuZWVkIHRvIGNvbmZpZ3VyZSBpdC4iCiAgICBleGl0IDAKZmkKCiMgRmluZCB0aGUgaW50ZXJmYWNlIHRoYXQgaGFzIHRoZSBkZWZhdWx0IHJvdXRlCkRFRkFVTFRfSU5URVJGQUNFPSQoaXAgcm91dGUgfCBncmVwIGRlZmF1bHQgfCBhd2sgJ3twcmludCAkNX0nIHwgaGVhZCAtbiAxKQoKaWYgWyAteiAiJERFRkFVTFRfSU5URVJGQUNFIiBdOyB0aGVuCiAgICBlY2hvICJFcnJvcjogQ291bGQgbm90IGZpbmQgaW50ZXJmYWNlIHdpdGggZGVmYXVsdCByb3V0ZSIgPiYyCiAgICBleGl0IDEKZmkKCmVjaG8gIkZvdW5kIGRlZmF1bHQgaW50ZXJmYWNlOiAkREVGQVVMVF9JTlRFUkZBQ0UiCgojIENyZWF0ZSBhIHRlbXBvcmFyeSBZQU1MIGZpbGUgd2l0aCB0aGUgaW50ZXJmYWNlIHN1YnN0aXR1dGVkClRNUF9GSUxFPSQobWt0ZW1wKQoKY2F0ID4gIiRUTVBfRklMRSIgPDwgRU9GCmludGVyZmFjZXM6CiAgLSBuYW1lOiBici1kcHUKICAgIHR5cGU6IGxpbnV4LWJyaWRnZQogICAgc3RhdGU6IHVwCiAgICBtdHU6ICROT0RFU19NVFUKICAgIGlwdjY6CiAgICAgIGVuYWJsZWQ6IGZhbHNlCiAgICBpcHY0OgogICAgICBlbmFibGVkOiB0cnVlCiAgICAgIGRoY3A6IHRydWUKICAgICAgYXV0by1kbnM6IHRydWUKICAgICAgYXV0by1nYXRld2F5OiB0cnVlCiAgICAgIGF1dG8tcm91dGVzOiB0cnVlCiAgICBicmlkZ2U6CiAgICAgIG9wdGlvbnM6CiAgICAgICAgc3RwOgogICAgICAgICAgZW5hYmxlZDogZmFsc2UKICAgICAgcG9ydDoKICAgICAgICAtIG5hbWU6ICRERUZBVUxUX0lOVEVSRkFDRQogIC0gbmFtZTogJERFRkFVTFRfSU5URVJGQUNFCiAgICB0eXBlOiBldGhlcm5ldAogICAgc3RhdGU6IHVwCiAgICBtdHU6ICROT0RFU19NVFUKRU9GCgplY2hvICJDcmVhdGVkIE5NU3RhdGUgY29uZmlndXJhdGlvbiB3aXRoIGludGVyZmFjZSAkREVGQVVMVF9JTlRFUkZBQ0UiCmVjaG8gIkFwcGx5aW5nIGNvbmZpZ3VyYXRpb24gdXNpbmcgbm1zdGF0ZWN0bC4uLiIKCiMgQXBwbHkgdGhlIGNvbmZpZ3VyYXRpb24Kbm1zdGF0ZWN0bCBhcHBseSAiJFRNUF9GSUxFIgpSRVNVTFQ9JD8KCiMgQ2xlYW4gdXAKcm0gIiRUTVBfRklMRSIKCiMgUmV0dXJuIHRoZSByZXN1bHQKZXhpdCAkUkVTVUxUCg==
          mode: 0755
          overwrite: true
          path: /usr/local/bin/apply-nmstate-bridge.sh
        - contents:
            source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKCiMgU2NyaXB0IHRvIHdhaXQgZm9yIE9WTi1LIGludGVyZmFjZSAoaWRlbnRpZmllZCBieSBsaW5rLWxvY2FsKSBhbmQgY29uZmlndXJlIHJvdXRpbmcgdGFibGUgMTAwCgpDSEVDS19JTlRFUlZBTD0yICAjIENoZWNrIGV2ZXJ5IDIgc2Vjb25kcwpQUklNQVJZX0lQX0ZJTEU9Ii9ydW4vbm9kZWlwLWNvbmZpZ3VyYXRpb24vcHJpbWFyeS1pcCIKCmVjaG8gIldhaXRpbmcgZm9yIHByaW1hcnkgSVAgZmlsZSB0byBkZXRlcm1pbmUgSVAgdmVyc2lvbi4uLiIKCiMgV2FpdCBmb3IgcHJpbWFyeS1pcCBmaWxlIGFuZCBkZXRlcm1pbmUgSVAgdmVyc2lvbiBmaXJzdAp3aGlsZSBbICEgLWYgIiRQUklNQVJZX0lQX0ZJTEUiIF0gfHwgWyAhIC1zICIkUFJJTUFSWV9JUF9GSUxFIiBdOyBkbwogICAgc2xlZXAgJENIRUNLX0lOVEVSVkFMCmRvbmUKCmJyX2RwdV9pcD0kKGNhdCAiJFBSSU1BUllfSVBfRklMRSIgfCB0ciAtZCAnWzpzcGFjZTpdJykKZWNobyAiVXNpbmcgYnItZHB1IElQIGZyb20gJFBSSU1BUllfSVBfRklMRTogJGJyX2RwdV9pcCIKCiMgRGV0ZWN0IElQIHZlcnNpb24gYmFzZWQgb24gYnItZHB1IElQIGFuZCBzZXQgYWxsIHZhcmlhYmxlcyBhY2NvcmRpbmdseQppZiBbWyAiJGJyX2RwdV9pcCIgPX4gOiBdXTsgdGhlbgogICAgSVBfVkVSU0lPTj0iNiIKICAgIElQX0ZMQUc9Ii02IgogICAgUFJFRklYX0xFTj0iMTI4IgogICAgTElOS19MT0NBTF9QQVRURVJOPSJeZmU4MDoiCiAgICBlY2hvICJEZXRlY3RlZCBJUHY2IGNvbmZpZ3VyYXRpb24iCmVsc2UKICAgIElQX1ZFUlNJT049IjQiCiAgICBJUF9GTEFHPSItNCIKICAgIFBSRUZJWF9MRU49IjMyIgogICAgTElOS19MT0NBTF9QQVRURVJOPSJeMTY5Wy5dMjU0IgogICAgZWNobyAiRGV0ZWN0ZWQgSVB2NCBjb25maWd1cmF0aW9uIgpmaQoKZWNobyAiV2FpdGluZyBmb3IgT1ZOLUsgaW50ZXJmYWNlICh3aXRoIGxpbmstbG9jYWwgYWRkcmVzcykgdG8gZ2V0IGFuIElQIGFkZHJlc3MuLi4iCgp3aGlsZSB0cnVlOyBkbwogICAgIyBGaW5kIGFsbCBpbnRlcmZhY2VzIHdpdGggbGluay1sb2NhbCBhZGRyZXNzZXMgdXNpbmcgSlNPTiBvdXRwdXQKICAgIG92bmtfaWZhY2VzPSQoaXAgLWogYWRkciBzaG93IHwganEgLS1hcmcgcGF0dGVybiAiJExJTktfTE9DQUxfUEFUVEVSTiIgLXIgJy5bXSB8IHNlbGVjdCguYWRkcl9pbmZvW10/IHwgLmxvY2FsIHwgdGVzdCgkcGF0dGVybikpIHwgLmlmbmFtZScgfCBzb3J0IC11KQogICAgCiAgICBmb3Igb3Zua19pZmFjZSBpbiAkb3Zua19pZmFjZXM7IGRvCiAgICAgICAgIyBHZXQgbm9uLWxpbmstbG9jYWwgSVAgYWRkcmVzcyBmb3IgdGhlIGRldGVjdGVkIElQIHZlcnNpb24KICAgICAgICBvdm5rX2lwPSQoaXAgJElQX0ZMQUcgLWogYWRkciBzaG93ICIkb3Zua19pZmFjZSIgfCBqcSAtLWFyZyBwYXR0ZXJuICIkTElOS19MT0NBTF9QQVRURVJOIiAtciAnLltdIHwgLmFkZHJfaW5mb1tdPyB8IHNlbGVjdCgubG9jYWwgfCB0ZXN0KCRwYXR0ZXJuKSB8IG5vdCkgfCAubG9jYWwnIHwgaGVhZCAtbjEpCiAgICAgICAgCiAgICAgICAgaWYgWyAtbiAiJG92bmtfaXAiIF07IHRoZW4KICAgICAgICAgICAgZWNobyAiRm91bmQgT1ZOLUsgaW50ZXJmYWNlOiAkb3Zua19pZmFjZSB3aXRoIElQdiR7SVBfVkVSU0lPTn06ICRvdm5rX2lwIgogICAgICAgICAgICAKICAgICAgICAgICAgIyBHZXQgYnItZHB1IG5ldHdvcmsgZnJvbSByb3V0aW5nIHRhYmxlIHVzaW5nIEpTT04KICAgICAgICAgICAgYnJfZHB1X25ldHdvcms9JChpcCAkSVBfRkxBRyAtaiByb3V0ZSBzaG93IGRldiBici1kcHUgfCBqcSAtciAnLltdIHwgc2VsZWN0KC5wcm90b2NvbCA9PSAia2VybmVsIikgfCAuZHN0JyB8IGhlYWQgLW4xKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgWyAteiAiJGJyX2RwdV9uZXR3b3JrIiBdOyB0aGVuCiAgICAgICAgICAgICAgICBlY2hvICJFcnJvcjogQ291bGQgbm90IGZpbmQgYnItZHB1IG5ldHdvcmsiCiAgICAgICAgICAgICAgICBleGl0IDEKICAgICAgICAgICAgZmkKICAgICAgICAgICAgCiAgICAgICAgICAgIGVjaG8gImJyLWRwdSBuZXR3b3JrOiAkYnJfZHB1X25ldHdvcmsiCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEdldCBici1kcHUgZ2F0ZXdheSBmcm9tIGRlZmF1bHQgcm91dGUKICAgICAgICAgICAgYnJfZHB1X2dhdGV3YXk9JChpcCAkSVBfRkxBRyAtaiByb3V0ZSB8IGpxIC1yICcuW10gfCBzZWxlY3QoLmRzdCA9PSAiZGVmYXVsdCIgYW5kIC5kZXYgPT0gImJyLWRwdSIpIHwgLmdhdGV3YXknIHwgaGVhZCAtbjEpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBbIC16ICIkYnJfZHB1X2dhdGV3YXkiIF07IHRoZW4KICAgICAgICAgICAgICAgIGVjaG8gIkVycm9yOiBDb3VsZCBub3QgZmluZCBnYXRld2F5IGZvciBici1kcHUiCiAgICAgICAgICAgICAgICBleGl0IDEKICAgICAgICAgICAgZmkKICAgICAgICAgICAgCiAgICAgICAgICAgIGVjaG8gImJyLWRwdSBnYXRld2F5OiAkYnJfZHB1X2dhdGV3YXkiCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEdldCBPVk4tSyBzdWJuZXQgZnJvbSBESENQIHJvdXRlCiAgICAgICAgICAgIG92bmtfc3VibmV0PSQoaXAgJElQX0ZMQUcgLWogcm91dGUgfCBqcSAtciAiLltdIHwgc2VsZWN0KC5kZXYgPT0gXCIkb3Zua19pZmFjZVwiIGFuZCAucHJvdG9jb2wgPT0gXCJkaGNwXCIgYW5kIC5kc3QgIT0gXCJkZWZhdWx0XCIpIHwgLmRzdCIgfCBoZWFkIC1uMSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIFsgLXogIiRvdm5rX3N1Ym5ldCIgXTsgdGhlbgogICAgICAgICAgICAgICAgZWNobyAiRXJyb3I6IENvdWxkIG5vdCBmaW5kIHN1Ym5ldCBmb3IgJG92bmtfaWZhY2UiCiAgICAgICAgICAgICAgICBleGl0IDEKICAgICAgICAgICAgZmkKICAgICAgICAgICAgCiAgICAgICAgICAgIGVjaG8gIk9WTi1LIHN1Ym5ldDogJG92bmtfc3VibmV0IgogICAgICAgICAgICAKICAgICAgICAgICAgIyBHZXQgbWV0cmljIGZyb20gYnItZHB1IChkZWZhdWx0IHRvIDQyNSBpZiBub3QgZm91bmQpCiAgICAgICAgICAgIGJyX2RwdV9tZXRyaWM9JChpcCAkSVBfRkxBRyAtaiByb3V0ZSBzaG93IGRldiBici1kcHUgfCBqcSAtciAnLltdIHwgc2VsZWN0KC5wcm90b2NvbCA9PSAia2VybmVsIikgfCAubWV0cmljIC8vIDQyNScgfCBoZWFkIC1uMSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGVjaG8gIiIKICAgICAgICAgICAgZWNobyAiQ3JlYXRpbmcgcm91dGluZyBydWxlcyBpbiB0YWJsZSAxMDAuLi4iCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDEuIEFkZCBwb2xpY3kgcm91dGluZyBydWxlCiAgICAgICAgICAgIGVjaG8gIkFkZGluZyBydWxlOiBmcm9tICRicl9kcHVfaXAvJFBSRUZJWF9MRU4gbG9va3VwIDEwMCIKICAgICAgICAgICAgIyBDaGVjayBpZiBydWxlIGFscmVhZHkgZXhpc3RzIHVzaW5nIEpTT04KICAgICAgICAgICAgaWYgaXAgJElQX0ZMQUcgLWogcnVsZSBsaXN0IHwganEgLWUgLS1hcmcgc3JjICIkYnJfZHB1X2lwIiAnLltdIHwgc2VsZWN0KC5zcmMgPT0gJHNyYyBhbmQgLnRhYmxlID09ICIxMDAiKScgPiAvZGV2L251bGwgMj4mMTsgdGhlbgogICAgICAgICAgICAgICAgZWNobyAiUnVsZSBhbHJlYWR5IGV4aXN0cyIKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgaXAgJElQX0ZMQUcgcnVsZSBhZGQgZnJvbSAkYnJfZHB1X2lwLyRQUkVGSVhfTEVOIGxvb2t1cCAxMDAgMj4vZGV2L251bGwgJiYgZWNobyAiUnVsZSBhZGRlZCBzdWNjZXNzZnVsbHkiIHx8IGVjaG8gIkZhaWxlZCB0byBhZGQgcnVsZSAobWF5IGFscmVhZHkgZXhpc3QpIgogICAgICAgICAgICBmaQogICAgICAgICAgICAKICAgICAgICAgICAgIyAyLiBBZGQgT1ZOLUsgcm91dGUgdmlhIGdhdGV3YXkKICAgICAgICAgICAgZWNobyAiQWRkaW5nIHJvdXRlOiAkb3Zua19zdWJuZXQgdmlhICRicl9kcHVfZ2F0ZXdheSB0YWJsZSAxMDAiCiAgICAgICAgICAgICMgQ2hlY2sgaWYgcm91dGUgYWxyZWFkeSBleGlzdHMgdXNpbmcgSlNPTgogICAgICAgICAgICBpZiBpcCAkSVBfRkxBRyAtaiByb3V0ZSBzaG93IHRhYmxlIDEwMCB8IGpxIC1lIC0tYXJnIGRzdCAiJG92bmtfc3VibmV0IiAnLltdIHwgc2VsZWN0KC5kc3QgPT0gJGRzdCknID4gL2Rldi9udWxsIDI+JjE7IHRoZW4KICAgICAgICAgICAgICAgIGVjaG8gIlJvdXRlIGFscmVhZHkgZXhpc3RzIgogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBpcCAkSVBfRkxBRyByb3V0ZSBhZGQgJG92bmtfc3VibmV0IHZpYSAkYnJfZHB1X2dhdGV3YXkgdGFibGUgMTAwIDI+L2Rldi9udWxsICYmIGVjaG8gIlJvdXRlIGFkZGVkIHN1Y2Nlc3NmdWxseSIgfHwgZWNobyAiRmFpbGVkIHRvIGFkZCByb3V0ZSAobWF5IGFscmVhZHkgZXhpc3QpIgogICAgICAgICAgICBmaQogICAgICAgICAgICAKICAgICAgICAgICAgIyAzLiBBZGQgYnItZHB1IHN1Ym5ldCByb3V0ZQogICAgICAgICAgICBlY2hvICJBZGRpbmcgcm91dGU6ICRicl9kcHVfbmV0d29yayBkZXYgYnItZHB1IHByb3RvIGtlcm5lbCBzY29wZSBsaW5rIHNyYyAkYnJfZHB1X2lwIG1ldHJpYyAkYnJfZHB1X21ldHJpYyB0YWJsZSAxMDAiCiAgICAgICAgICAgICMgQ2hlY2sgaWYgcm91dGUgYWxyZWFkeSBleGlzdHMgdXNpbmcgSlNPTgogICAgICAgICAgICBpZiBpcCAkSVBfRkxBRyAtaiByb3V0ZSBzaG93IHRhYmxlIDEwMCB8IGpxIC1lIC0tYXJnIGRzdCAiJGJyX2RwdV9uZXR3b3JrIiAnLltdIHwgc2VsZWN0KC5kc3QgPT0gJGRzdCBhbmQgLmRldiA9PSAiYnItZHB1IiknID4gL2Rldi9udWxsIDI+JjE7IHRoZW4KICAgICAgICAgICAgICAgIGVjaG8gIlJvdXRlIGFscmVhZHkgZXhpc3RzIgogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBpcCAkSVBfRkxBRyByb3V0ZSBhZGQgJGJyX2RwdV9uZXR3b3JrIGRldiBici1kcHUgcHJvdG8ga2VybmVsIHNjb3BlIGxpbmsgc3JjICRicl9kcHVfaXAgbWV0cmljICRicl9kcHVfbWV0cmljIHRhYmxlIDEwMCAyPi9kZXYvbnVsbCAmJiBlY2hvICJSb3V0ZSBhZGRlZCBzdWNjZXNzZnVsbHkiIHx8IGVjaG8gIkZhaWxlZCB0byBhZGQgcm91dGUgKG1heSBhbHJlYWR5IGV4aXN0KSIKICAgICAgICAgICAgZmkKICAgICAgICAgICAgCiAgICAgICAgICAgIGVjaG8gIiIKICAgICAgICAgICAgZWNobyAiUm91dGluZyBjb25maWd1cmF0aW9uIGNvbXBsZXRlZCEiCiAgICAgICAgICAgIGV4aXQgMAogICAgICAgIGZpCiAgICBkb25lCiAgICAKICAgIHNsZWVwICRDSEVDS19JTlRFUlZBTApkb25lCg==
          mode: 0755
          overwrite: true
          path: /usr/local/bin/configure-p0-routing.sh
        - contents:
            source: data:text/plain;charset=utf-8;base64,W2tleWZpbGVdCnVubWFuYWdlZC1kZXZpY2VzPWludGVyZmFjZS1uYW1lOm92bi1rOHMtKg==
          mode: 0644
          overwrite: true
          path: "/etc/NetworkManager/conf.d/unmanage-ovnk-interface.conf"
    systemd:
      units:
        - contents: |
            [Unit]
            Description=Apply NMState bridge configuration
            After=network.target NetworkManager.service
            Wants=NetworkManager.service
            
            [Service]
            Type=oneshot
            ExecStart=/usr/local/bin/apply-nmstate-bridge.sh <NODES_MTU>
            RemainAfterExit=yes
            
            [Install]
            WantedBy=multi-user.target
          enabled: true
          name: nmstate-bridge.service
        - name: ovs-configuration.service
          enabled: false
        - name: openvswitch.service
          enabled: false
          mask: true
        - name: wait-for-br-ex-up.service
          enabled: false
        - name: p0-routing.service
          enabled: true
          contents: |
            [Unit]
            Description=Configure p0 interface routing
            After=kubelet.service network-online.target
            Wants=network-online.target
            
            [Service]
            Type=oneshot
            ExecStart=/usr/local/bin/configure-p0-routing.sh
            RemainAfterExit=yes
            StandardOutput=journal
            StandardError=journal
            
            [Install]
            WantedBy=multi-user.target
